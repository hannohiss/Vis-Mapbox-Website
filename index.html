<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Data Joins</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        //YOUR TURN: Replace with a link to your CSV
        const csvUrl =
            "https://raw.githubusercontent.com/hannohiss/Vis-Mapbox-Website/main/housing_sf_other_w_census.csv"

        const csvPromise = papaPromise(csvUrl);
        // Mapbox Token
        mapboxgl.accessToken =
            "pk.eyJ1IjoiaGFubm9oaXNzIiwiYSI6ImNsdWd6NnNtNzBjaGkybHAyMXAwZW95dnYifQ.ugCpnrkxesS79JfAl9fhJw";
        var map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/light-v10", // YOUR TURN: choose a style: https://docs.mapbox.com/api/maps/#styles
            zoom: 7.5, // zoom level
            center: [-71, 42.2], // center ][lng, lat]
            transformRequest: transformRequest,
        });

        map.on("load", function () {
            csvPromise.then(function (results) {
                console.log(results.data);
                results.data.forEach((row) => {
                    map.setFeatureState(
                        {
                            // your source tileset and source layer
                            source: "mass-muni",
                            sourceLayer: "ma_municipalities_degrees-8uvqwo",
                            // unqiue ID row name
                            id: row.muni_id,
                        },
                        //YOUR TURN: Add rows you want to style/interact with
                        {
                            municipal: row.muni,
                            single_family: row.only_single_family,
                            // This is the query for "%_single_family", round to 2 decimal places
                            percentage_single_family: Math.round(row["%_single_family"] * 100) / 100,
                        }
                    );
                });
            });

            // YOUR TURN: Add source layer
            map.addSource("mass-muni", {
                type: "vector",
                url: "mapbox://hannohiss.890zal4l",
                promoteId: "muni_id",
            });

            map.addLayer({
                id: "mass-muni-fill",
                type: "fill",
                source: "mass-muni",
                "source-layer": "ma_municipalities_degrees-8uvqwo",
                layout: {},
                paint: {
                    'fill-color': [
                        'match',
                        ['feature-state', 'single_family'], // Attribute driving the color mapping, set in `setFeatureState`
                        '1', '#6BA0C7',
                        '0', '#CE575E',
                        '#CCC' // Default color if none of the values match
                    ],
                    'fill-opacity': 0.8
                }
            });

            map.addLayer({
                id: "mass-muni-line",
                type: "line",
                source: "mass-muni",
                "source-layer": "ma_municipalities_degrees-8uvqwo",
                layout: {
                    "line-join": "round",
                    "line-cap": "round",
                },
                paint: {
                    "line-color": "#D8CAC1",
                    "line-width": 1,
                },
            });
        });

        var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
        });

        map.on("mousemove", "mass-muni-fill", function (e) {
            map.getCanvas().style.cursor = "pointer";

            var muni = map.queryRenderedFeatures(e.point, {
                layers: ["mass-muni-fill"],
            });

            var FeatureState = muni[0].state; // Feature state
            var content = "";
            // iterate through the object
            for (var key in FeatureState) {
                if (FeatureState.hasOwnProperty(key)) {
                    content += "<b>" + key + "</b>" + ": " + FeatureState[key] + "<br>";
                }
            }
            popup.setLngLat(e.lngLat).setHTML(content).addTo(map);
        });

        map.on("mouseleave", "muni-fill", function () {
            map.getCanvas().style.cursor = "";
            popup.remove();
        });

        function transformRequest(url, resourceType) {
            var isMapboxRequest =
                url.slice(8, 22) === "api.mapbox.com" ||
                url.slice(10, 26) === "tiles.mapbox.com";
            return {
                url: isMapboxRequest
                    ? url.replace("?", "?pluginName=dataJoins&")
                    : url,
            };
        }
        function papaPromise(url) {
            return new Promise(function (resolve, reject) {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: resolve,
                });
            });
        }
    </script>
</body>

</html>